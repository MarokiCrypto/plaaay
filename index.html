<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>InstaPlay 🎮 (PBKDF2 Admin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:"Tajawal",sans-serif;
      background:linear-gradient(-45deg,#f9ce34,#ee2a7b,#6228d7,#f9ce34);
      background-size:400% 400%;animation:gradientMove 12s ease infinite;
      color:white;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:20px;}
    @keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{background:rgba(0,0,0,0.6);padding:20px;border-radius:18px;width:460px;max-width:95%;box-shadow:0 10px 30px rgba(0,0,0,0.5);margin:10px auto;}
    h1,h2,h3{margin:0 0 15px;text-align:center;}
    input,button,select{width:100%;margin:6px 0;padding:12px;border:none;border-radius:10px;font-size:15px;box-sizing:border-box;}
    input,select{background:#fff;color:#333}
    button{cursor:pointer;font-weight:bold;background:white;color:#6228d7;transition:.3s}
    button:hover{background:#ee2a7b;color:white;transform:scale(1.03)}
    .hidden{display:none}
    .games-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .game-btn{background:#fff;color:#6228d7;padding:14px;border-radius:10px;font-weight:bold;cursor:pointer;text-align:center}
    .game-btn:hover{background:#f9ce34;color:#000}
    table{width:100%;border-collapse:collapse;background:rgba(255,255,255,0.06);margin-top:10px;}
    th,td{padding:6px;border:1px solid rgba(255,255,255,0.08);font-size:13px;text-align:center;color:#fff}
    th{background:rgba(0,0,0,0.3)}
    @media (max-width:600px){
      .card{width:95%;padding:15px;}
      input,button,select{font-size:14px;padding:10px;}
      h1,h2,h3{font-size:18px;}
      .games-grid{grid-template-columns:1fr;}
    }
    .row{display:flex;gap:8px}
    .row> *{flex:1}
  </style>
</head>
<body>

<!-- 🔐 Auth -->
<div id="auth" class="card">
  <h1>🎮 InstaPlay</h1>
  <h3>Login / Register</h3>
  <input id="name" type="text" placeholder="Full name">
  <input id="email" type="text" placeholder="Email">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
  <button onclick="show('adminLogin')">👑 Admin Login</button>
</div>

<!-- 👑 Admin Login -->
<div id="adminLogin" class="card hidden">
  <h2>👑 Admin Login</h2>
  <input id="adminEmail" type="text" placeholder="Email">
  <input id="adminPass" type="password" placeholder="Password">
  <button onclick="adminLogin()">Login</button>
  <button onclick="backToAuth()">⬅️ Back</button>
  <p style="font-size:12px;color:#ddd;margin-top:8px;">
    الملاحظة: التحقق يتم باستخدام PBKDF2-HMAC-SHA256 (200,000 تكرار) — لكن يبقى على جهة العميل: الأفضل نقل التحقق للسيرفر لاحقاً.
  </p>
</div>

<!-- 👑 Admin Panel -->
<div id="adminPanel" class="card hidden">
  <h2>👑 Admin Panel</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>ID</th>
        <th>Balance</th>
        <th>Edit Balance</th>
        <th>Mode</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:10px;">
    <button onclick="backToAuth()">⬅️ Logout</button>
  </div>
</div>

<!-- 🎮 Dashboard -->
<div id="dashboard" class="card hidden">
  <h2>Welcome <span id="userName"></span></h2>
  <p>ID: <span id="userId"></span></p>
  <p>💰 Balance: <span id="balance"></span> $</p>
  <select id="betAmount" class="small">
    <option value="5">5$</option>
    <option value="10">10$</option>
    <option value="20">20$</option>
    <option value="50">50$</option>
  </select>

  <div class="games-grid">
    <div class="game-btn" onclick="hideAll();show('coinGame')">🪙 Coin</div>
    <div class="game-btn" onclick="hideAll();show('diceGame')">🎲 Dice</div>
    <div class="game-btn" onclick="hideAll();show('rpsGame')">✊✋✌️ RPS</div>
    <div class="game-btn" onclick="hideAll();show('slotGame')">🎰 Slot</div>
    <div class="game-btn" onclick="startMines()">💣 Mines</div>
  </div>

  <div style="margin-top:10px;display:flex;gap:8px;">
    <button onclick="show('historyCard');renderHistory()" style="flex:1">📜 Transactions</button>
    <button onclick="logout()" style="flex:1">🚪 Logout</button>
  </div>
</div>

<!-- 📜 Transactions -->
<div id="historyCard" class="card hidden">
  <h2>📜 Transactions</h2>
  <table id="historyTable">
    <thead><tr><th>Type</th><th>Amount</th><th>Date</th></tr></thead>
    <tbody></tbody>
  </table>
  <button onclick="backToDash()">⬅️ Back</button>
</div>

<!-- Games -->
<div id="coinGame" class="card hidden">
  <h2>🪙 Coin Toss</h2>
  <div id="coin" style="font-size:100px;transition:transform 1s;text-align:center">🪙</div>
  <div class="row">
    <button onclick="flipCoin('Heads')">Heads</button>
    <button onclick="flipCoin('Tails')">Tails</button>
  </div>
  <p id="coinResult"></p>
  <button onclick="backToDash()">⬅️ Back</button>
</div>

<div id="diceGame" class="card hidden">
  <h2>🎲 Dice</h2>
  <div id="dice" style="font-size:100px;margin:15px;text-align:center">🎲</div>
  <button onclick="rollDice()">🎲 Roll</button>
  <p id="diceResult"></p>
  <button onclick="backToDash()">⬅️ Back</button>
</div>

<div id="rpsGame" class="card hidden">
  <h2>✊✋✌️ Rock Paper Scissors</h2>
  <div style="display:flex;justify-content:space-around;font-size:60px;margin:15px 0;">
    <button onclick="playRPS('✊')">✊</button>
    <button onclick="playRPS('✋')">✋</button>
    <button onclick="playRPS('✌️')">✌️</button>
  </div>
  <div id="rpsBattle" style="display:flex;justify-content:space-around;font-size:40px;margin:20px 0;opacity:0;transition:opacity .5s;">
    <div>👤 <span id="playerChoice">❓</span></div>
    <div>VS</div>
    <div>🤖 <span id="computerChoice">❓</span></div>
  </div>
  <p id="rpsResult"></p>
  <button onclick="backToDash()">⬅️ Back</button>
</div>

<div id="slotGame" class="card hidden">
  <h2>🎰 Slot Machine</h2>
  <div id="slotReels" style="display:flex;justify-content:center;font-size:50px;gap:20px;margin:15px 0;">
    <span id="reel1">❓</span>
    <span id="reel2">❓</span>
    <span id="reel3">❓</span>
  </div>
  <button onclick="playSlot()">▶️ Spin</button>
  <p id="slotResult"></p>
  <button onclick="backToDash()">⬅️ Back</button>
</div>

<div id="minesGame" class="card hidden">
  <h2>💣 Mines</h2>
  <div id="minesGrid" style="display:grid;grid-template-columns:repeat(5,60px);gap:10px;justify-content:center;margin:15px 0;"></div>
  <p id="minesResult"></p>
  <div style="display:flex;gap:8px;">
    <button onclick="resetMines()">🔄 Reset</button>
    <button onclick="backToDash()">⬅️ Back</button>
  </div>
</div>

<script>
/* ===== Admin PBKDF2 constants =====
   Email (base64) and PBKDF2 hash (sha256) computed for password "special123"
   Salt (hex): 66316e6431675334742121  (ASCII: "f1nd1gS4t!")
   Iterations: 200000
   Derived (hex): 76c629f6d21f1bc6e863dbc1aae4cfb467eac69911b1ea9d53f247f114fc4973
*/
const ADMIN_EMAIL_ENC = "c3BlY2lhbEBnbWFpbC5jb20="; // base64(special@gmail.com)
const ADMIN_SALT_HEX  = "66316e6431675334742121";
const ADMIN_HASH_HEX  = "76c629f6d21f1bc6e863dbc1aae4cfb467eac69911b1ea9d53f247f114fc4973";
const PBKDF2_ITERATIONS = 200000;
const PBKDF2_HASH = "SHA-256";
const PBKDF2_DERIVED_BYTES = 32;

function b64decode(s){ try { return atob(s); } catch(e){ return ""; } }
function hexToArrayBuffer(hex){
  if(!hex) return new ArrayBuffer(0);
  const len = hex.length/2;
  const u8 = new Uint8Array(len);
  for(let i=0;i<len;i++){ u8[i] = parseInt(hex.substr(i*2,2),16); }
  return u8.buffer;
}
function arrayBufferToHex(buf){
  const u8 = new Uint8Array(buf);
  let s = "";
  for(let i=0;i<u8.length;i++){ let h = u8[i].toString(16); if(h.length===1) h = "0"+h; s += h; }
  return s;
}

/* derive PBKDF2 via WebCrypto, returns hex string */
async function derivePbkdf2Hex(password, saltHex, iterations, hash, dklenBytes){
  const enc = new TextEncoder();
  const passKey = await crypto.subtle.importKey("raw", enc.encode(password), {"name":"PBKDF2"}, false, ["deriveBits"]);
  const saltBuf = hexToArrayBuffer(saltHex);
  const derivedBits = await crypto.subtle.deriveBits(
    { name: "PBKDF2", hash: hash, salt: saltBuf, iterations: iterations },
    passKey,
    dklenBytes * 8 // bits
  );
  return arrayBufferToHex(derivedBits);
}

/* ===== Full app state & helpers (same as full version) ===== */
let currentUser = null;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, duration, type="sine"){ try { let o=audioCtx.createOscillator(); let g=audioCtx.createGain(); o.type=type;o.frequency.setValueAtTime(freq,audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+duration/1000); o.stop(audioCtx.currentTime+duration/1000);}catch(e){}}
function soundClick(){ playTone(500, 80, "square"); }
function soundWin(){ playTone(700, 140, "sine"); setTimeout(()=>playTone(900,120,"sine"),160); }
function soundLose(){ playTone(300, 220, "sawtooth"); }

function uid(){ return "UID"+Math.floor(Math.random()*99999); }
function userKey(email){ return "user_"+email; }
function saveUser(u){ try{ localStorage.setItem(userKey(u.email), JSON.stringify(u)); }catch(e){} }
function loadUser(email){ try{ return JSON.parse(localStorage.getItem(userKey(email))); }catch(e){ return null; } }
function allUsers(){ let arr=[]; for(let i=0;i<localStorage.length;i++){ let k=localStorage.key(i); if(k && k.startsWith("user_")){ try{ arr.push(JSON.parse(localStorage.getItem(k))); }catch(e){} } } return arr; }

function hideAll(){ document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden")); }
function show(id){ hideAll(); document.getElementById(id).classList.remove("hidden"); }
function backToAuth(){ hideAll(); show("auth"); }
function backToDash(){ hideAll(); show("dashboard"); }

function escapeHtml(unsafe) {
  if(unsafe === undefined || unsafe === null) return "";
  return String(unsafe).replace(/[&<>"'`=\/]/g, function(s){ return ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'
  })[s]; });
}

/* ===== Auth (users, localStorage) ===== */
function register(){
  let name = document.getElementById("name").value.trim();
  let email = document.getElementById("email").value.trim().toLowerCase();
  let pass = document.getElementById("pass").value;
  if(!name || !email || !pass){ alert("Fill all fields"); return; }
  if(loadUser(email)){ alert("Account already exists"); return; }
  let u = { name, email, password: pass, balance: 20, id: uid(), mode: "normal" };
  saveUser(u);
  currentUser = u;
  updateUI();
  alert("Registered successfully — 20$ bonus added.");
  show("dashboard");
  renderUsers();
}

function login(){
  let email = document.getElementById("email").value.trim().toLowerCase();
  let pass = document.getElementById("pass").value;
  let u = loadUser(email);
  if(!u || u.password !== pass){ alert("Invalid credentials"); return; }
  currentUser = u;
  updateUI();
  show("dashboard");
}

function logout(){
  currentUser = null;
  backToAuth();
}

/* ===== Admin Login using PBKDF2 (async) ===== */
async function adminLogin(){
  const email = document.getElementById("adminEmail").value.trim();
  const pass  = document.getElementById("adminPass").value;
  const realEmail = b64decode(ADMIN_EMAIL_ENC);

  if(email !== realEmail){
    alert("❌ Wrong admin email"); return;
  }
  if(!pass){ alert("Enter password"); return; }

  // disable button feedback (best-effort)
  let btn;
  try { btn = event && event.target; if(btn){ btn.disabled=true; btn.innerText="Checking..."; } } catch(e){}

  try {
    const derivedHex = await derivePbkdf2Hex(pass, ADMIN_SALT_HEX, PBKDF2_ITERATIONS, PBKDF2_HASH, PBKDF2_DERIVED_BYTES);
    if(derivedHex === ADMIN_HASH_HEX){
      alert("✅ Admin authenticated");
      show("adminPanel");
      renderUsers();
    } else {
      alert("❌ Wrong admin password");
    }
  } catch(err){
    console.error(err);
    alert("Error during verification");
  } finally {
    if(btn){ btn.disabled=false; btn.innerText="Login"; }
  }
}

/* ===== Admin panel functions ===== */
function renderUsers(){
  let tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  let users = allUsers();
  users.forEach(u=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.id)}</td>
      <td>${escapeHtml(u.balance)}</td>
      <td style="min-width:140px">
        <div style="display:flex;gap:6px;">
          <input type='number' value='${u.balance}' id='bal_${u.email}' style="flex:1;padding:6px;border-radius:6px;border:none">
          <button onclick="updateBal('${u.email.replace(/'/g,"\\'")}')">✔️</button>
        </div>
      </td>
      <td>
        <select id="mode_${u.email}" onchange="changeMode('${u.email.replace(/'/g,"\\'")}')">
          <option value="normal" ${u.mode==="normal"?"selected":""}>⚖️ Normal</option>
          <option value="win" ${u.mode==="win"?"selected":""}>🔥 Always Win</option>
          <option value="lose" ${u.mode==="lose"?"selected":""}>❌ Always Lose</option>
        </select>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function updateBal(email){
  let inp = document.getElementById("bal_"+email);
  if(!inp) return;
  let u = loadUser(email);
  if(!u) return;
  u.balance = parseInt(inp.value) || 0;
  saveUser(u);
  renderUsers();
}
function changeMode(email){
  let sel = document.getElementById("mode_"+email);
  if(!sel) return;
  let u = loadUser(email);
  if(!u) return;
  u.mode = sel.value;
  saveUser(u);
  renderUsers();
}

/* ===== Transactions history ===== */
function addHistory(type, amount){
  if(!currentUser) return;
  let key = "history_" + currentUser.email;
  let h = JSON.parse(localStorage.getItem(key) || "[]");
  h.push({ type, amount, date: new Date().toLocaleString() });
  localStorage.setItem(key, JSON.stringify(h));
}
function renderHistory(){
  if(!currentUser){ alert("No user"); return; }
  let tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";
  let h = JSON.parse(localStorage.getItem("history_" + currentUser.email) || "[]");
  h.slice().reverse().forEach(op=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(op.type)}</td><td>${escapeHtml(op.amount + "$")}</td><td>${escapeHtml(op.date)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Betting helpers ===== */
function getBet(){
  if(!currentUser){ alert("Please login"); return null; }
  let v = parseInt(document.getElementById("betAmount").value);
  if(currentUser.balance < v){ alert("Not enough balance"); return null; }
  return v;
}
function forceResult(){
  if(!currentUser) return "normal";
  return currentUser.mode || "normal";
}

/* ===== Games (same as before) ===== */
/* Coin */
function flipCoin(choice){
  let bet = getBet(); if(!bet) return; soundClick();
  let mode = forceResult(); let result;
  if(mode === "win"){ result = choice; }
  else if(mode === "lose"){ result = (choice === "Heads" ? "Tails" : "Heads"); }
  else { result = Math.random() < 0.5 ? "Heads" : "Tails"; }

  let coin = document.getElementById("coin");
  coin.style.transform = "rotateY(720deg)";
  setTimeout(()=>{
    coin.innerText = (result === "Heads") ? "🪙" : "💰";
    if(result === choice){
      currentUser.balance += bet;
      document.getElementById("coinResult").innerText = "🎉 Win +" + bet + "$";
      soundWin(); addHistory("Win (Coin)", bet);
    } else {
      currentUser.balance -= bet;
      document.getElementById("coinResult").innerText = "❌ Lose -" + bet + "$";
      soundLose(); addHistory("Lose (Coin)", -bet);
    }
    updateUI();
    renderUsers();
  }, 900);
}

/* Dice */
function rollDice(){
  let bet = getBet(); if(!bet) return; soundClick();
  let mode = forceResult(); let r;
  if(mode === "win"){ r = 6; } else if(mode === "lose"){ r = 1; } else { r = Math.floor(Math.random()*6)+1; }
  let faces = ["⚀","⚁","⚂","⚃","⚄","⚅"];
  document.getElementById("dice").style.transform = "rotate(360deg)";
  setTimeout(()=>{
    document.getElementById("dice").innerText = faces[r-1];
    if(r >= 4){
      currentUser.balance += bet;
      document.getElementById("diceResult").innerText = "🎉 Win ("+r+") +" + bet + "$";
      soundWin(); addHistory("Win (Dice)", bet);
    } else {
      currentUser.balance -= bet;
      document.getElementById("diceResult").innerText = "❌ Lose ("+r+") -" + bet + "$";
      soundLose(); addHistory("Lose (Dice)", -bet);
    }
    updateUI();
    renderUsers();
  }, 700);
}

/* RPS */
function playRPS(player){
  let bet = getBet(); if(!bet) return; soundClick();
  let mode = forceResult();
  let options = ["✊","✋","✌️"];
  let comp;
  if(mode === "win"){ comp = (player==="✊"?"✌️":player==="✋"?"✊":"✋"); }
  else if(mode === "lose"){ comp = (player==="✊"?"✋":player==="✋"?"✌️":"✊"); }
  else { comp = options[Math.floor(Math.random()*3)]; }

  document.getElementById("playerChoice").innerText = player;
  document.getElementById("computerChoice").innerText = comp;
  document.getElementById("rpsBattle").style.opacity = 1;

  let result="";
  if(player === comp){ result = "🤝 Draw"; addHistory("Draw (RPS)", 0); }
  else if((player==="✊"&&comp==="✌️")||(player==="✋"&&comp==="✊")||(player==="✌️"&&comp==="✋")){
    currentUser.balance += bet; result = "🎉 Win +" + bet + "$"; soundWin(); addHistory("Win (RPS)", bet);
  } else {
    currentUser.balance -= bet; result = "❌ Lose -" + bet + "$"; soundLose(); addHistory("Lose (RPS)", -bet);
  }
  document.getElementById("rpsResult").innerText = result;
  updateUI();
  renderUsers();
}

/* Slot */
function playSlot(){
  let bet = getBet(); if(!bet) return; soundClick();
  let mode = forceResult();
  let s = ["🍒","🍋","⭐","🔔","7️⃣"];
  let reels = [document.getElementById("reel1"), document.getElementById("reel2"), document.getElementById("reel3")];
  let spins = 20; let i = 0;
  let spinInterval = setInterval(()=>{
    reels.forEach(r => r.innerText = s[Math.floor(Math.random()*s.length)]);
    i++;
    if(i > spins){
      clearInterval(spinInterval);
      let rvals;
      if(mode === "win"){ rvals = ["7️⃣","7️⃣","7️⃣"]; }
      else if(mode === "lose"){ rvals = ["🍒","⭐","🔔"]; }
      else { rvals = [s[Math.floor(Math.random()*s.length)], s[Math.floor(Math.random()*s.length)], s[Math.floor(Math.random()*s.length)]]; }

      reels[0].innerText = rvals[0]; reels[1].innerText = rvals[1]; reels[2].innerText = rvals[2];

      if(rvals[0] === rvals[1] && rvals[1] === rvals[2]){
        currentUser.balance += bet*5;
        document.getElementById("slotResult").innerText = "🎉 Jackpot!! +" + (bet*5) + "$";
        soundWin(); addHistory("Jackpot (Slot)", bet*5);
      } else if(rvals[0] === rvals[1] || rvals[1] === rvals[2] || rvals[0] === rvals[2]){
        currentUser.balance += bet;
        document.getElementById("slotResult").innerText = "✨ Small Win +" + bet + "$";
        soundWin(); addHistory("Win (Slot)", bet);
      } else {
        currentUser.balance -= bet;
        document.getElementById("slotResult").innerText = "❌ Lose -" + bet + "$";
        soundLose(); addHistory("Lose (Slot)", -bet);
      }
      updateUI();
      renderUsers();
    }
  }, 90);
}

/* Mines */
let minesData = [];
let minesActive = true;
function startMines(){ hideAll(); show("minesGame"); resetMines(); }
function resetMines(){
  let g = document.getElementById("minesGrid");
  g.innerHTML = "";
  minesData = [];
  minesActive = true;
  for(let i=0;i<25;i++){
    let mine = Math.random() < 0.2;
    minesData.push(mine);
    let b = document.createElement("button");
    b.innerText = "❓"; b.style.width = "60px"; b.style.height = "60px"; b.style.fontSize = "22px";
    b.onclick = ()=> clickMine(i, b);
    g.appendChild(b);
  }
  document.getElementById("minesResult").innerText = "";
}
function clickMine(i, btn){
  if(!minesActive) return;
  soundClick();
  let bet = getBet(); if(!bet) return;
  let mode = forceResult();
  if(mode === "lose" || minesData[i]){
    btn.innerText = "💣"; btn.style.background = "#ff4444"; currentUser.balance -= bet; minesActive = false;
    document.getElementById("minesResult").innerText = "❌ Boom! -" + bet + "$";
    soundLose(); addHistory("Lose (Mines)", -bet);
  } else {
    btn.innerText = "💎"; btn.style.background = "#44ff44"; currentUser.balance += bet;
    document.getElementById("minesResult").innerText = "🎉 Safe! +" + bet + "$";
    soundWin(); addHistory("Win (Mines)", bet);
  }
  updateUI();
  renderUsers();
}

/* UI update */
function updateUI(){
  if(!currentUser) return;
  document.getElementById("userName").innerText = currentUser.name;
  document.getElementById("userId").innerText = currentUser.id;
  document.getElementById("balance").innerText = currentUser.balance;
  saveUser(currentUser);
}

/* On load */
window.addEventListener("load", ()=>{
  hideAll(); show("auth");
});
</script>

</body>
</html>
